<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <button class="return-button" onclick="history.back()">
    ← RETURN
    </button>

  <h2></h2>
  <link rel="icon" type="image/png" href="logo.png" />
  <title>GOODFARMER - Farm Lookup</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      padding: 20px;
      box-sizing: border-box;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 800px;
      margin: 0 auto;
    }

    .section {
      background-color: #fff;
      border-radius: 15px;
      padding: 30px;
      width: 100%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    h1 {
      text-align: center;
      color: #ed1922;
      margin-bottom: 10px;
    }

    .logo {
      display: block;
      margin: -40px auto 10px;
      width: 250px;
      height: auto;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: stretch;
    }

    label {
      font-weight: 600;
      color: #333;
      font-size: 1rem;
      margin-bottom: 5px;
    }

    /* Contenedor del select personalizado */
    .custom-select {
      position: relative;
      width: 100%;
    }

    .select-input {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      background: white;
      transition: border-color 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .select-input:focus {
      outline: none;
      border-color: #ed1922;
    }

    .select-input:hover {
      border-color: #ed1922;
    }

    .select-arrow {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #666;
      transition: transform 0.3s ease;
      margin-left: 10px;
      flex-shrink: 0;
    }

    .select-arrow.open {
      transform: rotate(180deg);
    }

    /* Contenedor de opciones */
    .options-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 0;
      overflow: hidden;
      z-index: 1000;
      transition: max-height 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .options-container.open {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Campo de búsqueda */
    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: none;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
      box-sizing: border-box;
      background: #f8f9fa;
    }

    .search-input:focus {
      outline: none;
      background: white;
      border-bottom-color: #ed1922;
    }

    .search-input::placeholder {
      color: #999;
      font-style: italic;
    }

    /* Opciones */
    .option {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
    }

    .option:hover {
      background-color: #f8f9fa;
    }

    .option:last-child {
      border-bottom: none;
    }

    .option.selected {
      background-color: #ed1922;
      color: white;
    }

    .option.hidden {
      display: none;
    }

    .no-results {
      padding: 8px 12px;
      text-align: center;
      color: #666;
      font-style: italic;
    }

    button {
      background-color: #ed1922;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #c2161b;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .result-container {
      margin-top: 20px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .result-container.show {
      opacity: 1;
      transform: translateY(0);
    }

    .farm-info {
      background-color: #f0f0f0;
      padding: 20px;
      border-radius: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 500px;
      overflow-y: auto;
    }

    .farm-info a {
      color: #ed1922;
      text-decoration: underline;
    }

    .farm-info a:hover {
      color: #c2161b;
      text-decoration: none;
    }

    .error {
      background: #ffe6e6;
      color: #d63031;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #d63031;
      margin-top: 15px;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    @media (max-width: 600px) {
      .section {
        padding: 20px;
        margin: 10px;
      }

      .options-container.open {
        max-height: 250px;
      }
    }
  </style>
</head>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmUv7lO9JvDkc40DNHGjstcYm8N508EPA",
    authDomain: "goodfarmer-af4db.firebaseapp.com",
    projectId: "goodfarmer-af4db",
    storageBucket: "goodfarmer-af4db.firebasestorage.app",
    messagingSenderId: "825592484658",
    appId: "1:825592484658:web:f52f7b7d2ea8b486977d2b",
    measurementId: "G-XVSJHN43Q3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
    }
  });
</script>
<body>

  <div class="container">
    <div class="section">
  <img src="logo.png" alt="GoodFarmer Logo" class="logo" />

  <h1>FARMS INFO</h1>
      
      <form id="farmForm">
        <label for="farm">SELECT FARM:</label>
        
        <div class="custom-select">
          <div class="select-input" id="selectInput">
            <span id="selectedText">Loading farms...</span>
            <div class="select-arrow" id="selectArrow"></div>
          </div>
          
          <div class="options-container" id="optionsContainer">
            <input type="text" class="search-input" id="searchInput" placeholder="Search farms...">
            <div id="optionsList"></div>
          </div>
        </div>
        
        <button type="submit" id="submitBtn" disabled>Get Farm Info</button>
      </form>

      <div id="resultado" class="result-container"></div>
    </div>
  </div>

  <script>
    const selectInput = document.getElementById('selectInput');
    const selectedText = document.getElementById('selectedText');
    const selectArrow = document.getElementById('selectArrow');
    const optionsContainer = document.getElementById('optionsContainer');
    const searchInput = document.getElementById('searchInput');
    const optionsList = document.getElementById('optionsList');
    const submitBtn = document.getElementById('submitBtn');
    const resultado = document.getElementById('resultado');
    const form = document.getElementById('farmForm');
    
    let farmsData = [];
    let selectedFarmIndex = null;
    let isOpen = false;

    // Cargar datos de las fincas usando múltiples métodos
    async function loadFarms() {
      try {
        await loadFarmsWithProxy();
      } catch (error1) {
        console.warn('Proxy method failed:', error1);
        try {
          await loadFarmsDirect();
        } catch (error2) {
          console.warn('Direct method failed:', error2);
          try {
            await loadFarmsJSONP();
          } catch (error3) {
            console.error('All methods failed:', error3);
            loadSampleData();
          }
        }
      }
    }

    async function loadFarmsWithProxy() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_e-zu9dC1Pzk3XmaKAMP4YhntP2yJ87Tkn6-uQd1flmv7cuY2yjdpK6XTZMKyCd2Qw7Ux41V8dUKx/pub?gid=2031029481&single=true&output=csv';
      const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl);
      
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const csvText = await response.text();
      processCsvData(csvText);
    }

    async function loadFarmsDirect() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_e-zu9dC1Pzk3XmaKAMP4YhntP2yJ87Tkn6-uQd1flmv7cuY2yjdpK6XTZMKyCd2Qw7Ux41V8dUKx/pub?gid=2031029481&single=true&output=csv';
      
      const response = await fetch(csvUrl, {
        mode: 'cors',
        headers: {
          'Accept': 'text/csv,*/*'
        }
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const csvText = await response.text();
      processCsvData(csvText);
    }

    async function loadFarmsJSONP() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_e-zu9dC1Pzk3XmaKAMP4YhntP2yJ87Tkn6-uQd1flmv7cuY2yjdpK6XTZMKyCd2Qw7Ux41V8dUKx/pub?gid=2031029481&single=true&output=csv';
      const corsProxy = 'https://corsproxy.io/?' + encodeURIComponent(csvUrl);
      
      const response = await fetch(corsProxy);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const csvText = await response.text();
      processCsvData(csvText);
    }

    function processCsvData(csvText) {
      const lines = csvText.split('\n');
      farmsData = [];
      
      console.log('Processing CSV with', lines.length, 'lines');
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const columns = parseCSVLine(line);
        
        if (columns.length >= 2) {
          const supplier = columns[0]?.trim() || '';
          const farmName = columns[1]?.trim() || '';
          const province = columns[2]?.trim() || '';
          const farmCode = columns[4]?.trim() || '';
          const orchardCode = columns[5]?.trim() || '';
          const rucCode = columns[6]?.trim() || '';
          
          if (farmName && farmName !== 'FARMS' && farmName !== 'SUPPLIER') {
            const farmData = {
              name: farmName,
              supplier: supplier,
              location: province,
              farmCode: farmCode,
              orchardCode: orchardCode,
              rucCode: rucCode
            };
            
            farmsData.push(farmData);
          }
        }
      }
      
      console.log(`Successfully loaded ${farmsData.length} farms`);
      
      if (farmsData.length === 0) {
        throw new Error('No valid farm data found');
      }
      
      updateSelectDisplay();
      populateOptions();
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    function loadSampleData() {
      farmsData = [
        {
          name: "ALICIA - AGRO FRESH",
          supplier: "AGRO FRESH",
          location: "GUAYAS",
          farmCode: "7190",
          orchardCode: "",
          rucCode: ""
        },
        {
          name: "PEPITA - AGRO FRESH",
          supplier: "AGRO FRESH",
          location: "LOS RIOS",
          farmCode: "",
          orchardCode: "",
          rucCode: ""
        },
        {
          name: "DON VALEN - ANDRADE COMEX",
          supplier: "ANDRADE COMEX",
          location: "GUAYAS",
          farmCode: "10284",
          orchardCode: "",
          rucCode: "0993372966001"
        },
        {
          name: "LA REVESA - ANDRADE COMEX",
          supplier: "ANDRADE COMEX",
          location: "LOS RIOS",
          farmCode: "03200",
          orchardCode: "03200",
          rucCode: "0993372966001"
        }
      ];
      
      updateSelectDisplay();
      populateOptions();
    }

    function updateSelectDisplay() {
        if (selectedFarmIndex !== null) {
            const farm = farmsData[selectedFarmIndex];
            // Tomar solo la primera parte de farm.name
            const farmNameClean = farm.name.split(' - ')[0];
            selectedText.textContent = `${farm.supplier || 'N/A'} - ${farm.farmCode || 'N/A'} - ${farmNameClean}`;
            submitBtn.disabled = false;
        } else {
            selectedText.textContent = farmsData.length > 0 ? 'Select a farm...' : 'Loading farms...';
            submitBtn.disabled = true;
        }
    }


    function populateOptions() {
      optionsList.innerHTML = '';
      
      farmsData.forEach((farm, index) => {
        const option = document.createElement('div');
        option.className = 'option';
        
        const farmNameClean = farm.name.split(' - ')[0];
        option.textContent = `${farm.supplier || 'N/A'} - ${farm.farmCode || 'N/A'} - ${farmNameClean}`;
        
        option.dataset.index = index;
        
        option.addEventListener('click', () => {
            selectFarm(index);
        });
        
        optionsList.appendChild(option);
        });
    }

    function selectFarm(index) {
      selectedFarmIndex = index;
      updateSelectDisplay();
      closeSelect();
      
      // Update selected option visual state
      document.querySelectorAll('.option').forEach((opt, i) => {
        opt.classList.toggle('selected', i === index);
      });
    }

    function openSelect() {
      if (isOpen) return;
      
      isOpen = true;
      optionsContainer.classList.add('open');
      selectArrow.classList.add('open');
      searchInput.focus();
      searchInput.value = '';
      filterOptions('');
    }

    function closeSelect() {
      isOpen = false;
      optionsContainer.classList.remove('open');
      selectArrow.classList.remove('open');
    }

    function filterOptions(searchTerm) {
      const options = document.querySelectorAll('.option');
      let visibleCount = 0;
      
      options.forEach(option => {
        const farmName = option.textContent.toLowerCase();
        const matches = farmName.includes(searchTerm.toLowerCase());
        
        option.classList.toggle('hidden', !matches);
        if (matches) visibleCount++;
      });
      
      // Show/hide no results message
      let noResultsMsg = document.querySelector('.no-results');
      if (visibleCount === 0) {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.className = 'no-results';
          noResultsMsg.textContent = 'No farms found';
          optionsList.appendChild(noResultsMsg);
        }
        noResultsMsg.style.display = 'block';
      } else if (noResultsMsg) {
        noResultsMsg.style.display = 'none';
      }
    }

    // Event listeners
    selectInput.addEventListener('click', () => {
      if (isOpen) {
        closeSelect();
      } else {
        openSelect();
      }
    });

    searchInput.addEventListener('input', (e) => {
      filterOptions(e.target.value);
    });

    searchInput.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Close select when clicking outside
    document.addEventListener('click', (e) => {
      if (!selectInput.contains(e.target) && !optionsContainer.contains(e.target)) {
        closeSelect();
      }
    });

    // Handle keyboard navigation
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeSelect();
      } else if (e.key === 'Enter') {
        const visibleOptions = Array.from(document.querySelectorAll('.option:not(.hidden)'));
        if (visibleOptions.length === 1) {
          const index = parseInt(visibleOptions[0].dataset.index);
          selectFarm(index);
        }
      }
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (selectedFarmIndex === null) {
        showError('Please select a farm');
        return;
      }
      
      const farmData = farmsData[selectedFarmIndex];
      if (!farmData) {
        showError('Farm data not found');
        return;
      }
      
      showFarmInfo(farmData);
    });

    function showFarmInfo(farm) {
      const farmInfoDiv = document.createElement('div');
      farmInfoDiv.className = 'farm-info';

      // NUEVA versión de createLocationElement
      function createLocationElement(location) {
        if (!location || location === 'N/A') {
          return document.createTextNode('N/A');
        }

        const container = document.createElement('span');
        container.textContent = location + " ";

        // botón "Ver en Maps"
        const btn = document.createElement('button');
        btn.className = "map-btn";
        btn.textContent = "Ver en Maps";
        btn.addEventListener('click', () => {
          window.open(
            `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`,
            '_blank'
          );
        });

        container.appendChild(btn);
        return container;
      }

      farmInfoDiv.appendChild(document.createTextNode('NAME: ' + (farm.name || 'N/A') + '\n'));
      farmInfoDiv.appendChild(document.createTextNode('SUPPLIER: ' + (farm.supplier || 'N/A') + '\n'));

      farmInfoDiv.appendChild(document.createTextNode('LOCATION: '));
      farmInfoDiv.appendChild(createLocationElement(farm.location));
      farmInfoDiv.appendChild(document.createTextNode('\n'));

      farmInfoDiv.appendChild(document.createTextNode('FARM CODE: ' + (farm.farmCode || 'N/A') + '\n'));
      farmInfoDiv.appendChild(document.createTextNode('ORCHARD CODE: ' + (farm.orchardCode || 'N/A') + '\n'));
      farmInfoDiv.appendChild(document.createTextNode('RUC CODE: ' + (farm.rucCode || 'N/A')));

      resultado.innerHTML = '';
      resultado.appendChild(farmInfoDiv);
      resultado.classList.add('show');
    }

    function showError(message) {
      resultado.innerHTML = `<div class="error">${message}</div>`;
      resultado.classList.add('show');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadFarms);
  </script>

</body>
</html>