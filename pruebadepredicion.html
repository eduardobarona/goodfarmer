<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoodFarmer - Farm Quality Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px auto;
            max-width: 200px;
            height: auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section {
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .custom-select {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }

        .select-input {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px 40px 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .select-input:hover {
            border-color: #667eea;
        }

        .select-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #666;
            transition: transform 0.3s ease;
        }

        .select-arrow.open {
            transform: rotate(180deg);
        }

        .options-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .options-container.open {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            outline: none;
        }

        .option {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .option:hover {
            background-color: #f8f9fa;
        }

        .option.selected {
            background-color: #667eea;
            color: white;
        }

        .option.hidden {
            display: none;
        }

        .no-results {
            padding: 12px;
            color: #666;
            font-style: italic;
        }

        .loading {
            padding: 12px;
            color: #666;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            margin-top: 30px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .farm-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .farm-header div {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .overview-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .overview-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .big-number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .good-card {
            border-left: 5px solid #28a745;
        }

        .bad-card {
            border-left: 5px solid #dc3545;
        }

        .stats-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .stats-label {
            font-weight: bold;
            color: #666;
        }

        .stats-value {
            font-weight: bold;
            color: #333;
        }

        .stats-value.good {
            color: #28a745;
        }

        .stats-value.bad {
            color: #dc3545;
        }

        .bad-containers-list {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }

        .bad-containers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .bad-containers-table th,
        .bad-containers-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .bad-containers-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bad-containers-table td {
            color: #333;
        }

        .bad-containers-table .container-id {
            font-weight: bold;
            color: #dc3545;
        }

        .bad-containers-table .metric-value {
            font-weight: 600;
        }

        .bad-containers-table .metric-value.high {
            color: #dc3545;
        }

        .bad-containers-table .metric-value.low {
            color: #fd7e14;
        }

        .overlap-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            font-size: 0.9em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #dc3545;
            margin-top: 20px;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-top: 20px;
            display: inline-block;
        }

        .weekly-analysis {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .weekly-header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
        }

        .week-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .week-selector label {
            font-size: 1.1em;
            color: #495057;
            margin: 0;
        }

        .week-selector select {
            padding: 10px 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            min-width: 120px;
        }

        .week-selector select:focus {
            outline: none;
            border-color: #6f42c1;
        }

        .search-week-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            padding: 10px 25px;
            font-size: 16px;
            margin: 0;
        }

        .containers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .container-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #6f42c1;
        }

        .container-header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: -10px -10px 15px -10px;
            font-weight: bold;
            text-align: center;
        }

        .problem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .problem-item:last-child {
            border-bottom: none;
        }

        .problem-label {
            font-weight: 600;
            color: #495057;
        }

        .problem-percentage {
            font-weight: bold;
            color: #dc3545;
            font-size: 1.1em;
        }

        .photos-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f8f9fa;
        }

        .photos-header {
            font-weight: bold;
            color: #6f42c1;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10px;
            border-radius: 8px;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .problem-photos-container {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
        }

        .problem-title {
            font-weight: bold; 
            color: #495057; 
            margin-bottom: 8px; 
            font-size: 0.95em;
            padding: 8px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .photo-link {
            width: 80px;
            height: 80px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            text-decoration: none;
            color: #6c757d;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-link:hover {
            border-color: #6f42c1;
            color: #6f42c1;
            transform: scale(1.05);
        }

        .photo-link img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .no-containers {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
            background: white;
            border-radius: 12px;
            margin-top: 20px;
        }

        .loading-weekly {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .cors-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 900px;
            max-height: 80%;
            object-fit: contain;
        }

        .modal-caption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 900px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            font-size: 16px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #f1f1f1;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 5px;
            transition: 0.3s;
        }

        .modal-nav:hover {
            background: rgba(0,0,0,0.8);
        }

        .modal-prev {
            left: 20px;
        }

        .modal-next {
            right: 20px;
        }

        .charts-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .charts-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
        }

        .chart-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .quality-score {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .quality-score h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .quality-percentage {
            font-size: 3.5em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .quality-description {
            font-size: 1.1em;
            opacity: 0.9;
            margin-top: 10px;
        }
        .bad-week-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }

        .visit-note {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .bad-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .summary-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

  <img src="logo.png" alt="GoodFarmer Logo" class="logo" />

  <h1>GOODFARMER - FARM QUALITY ANALYSIS</h1>

<script>
// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  generateWeekOptions();
});
</script>

  <div class="container">
    <div class="section">
      <form id="formFinca">
        <label for="farmLabel">FARM:</label>
        
        <div class="custom-select">
          <div class="select-input" id="selectInput">
            <span id="selectedText">Loading farms...</span>
            <div class="select-arrow" id="selectArrow"></div>
          </div>
          
          <div class="options-container" id="optionsContainer">
            <input type="text" class="search-input" id="searchInput" placeholder="Search farm...">
            <div id="optionsList">
              <div class="loading">Loading farms...</div>
            </div>
          </div>
        </div>
        
        <button type="submit" id="submitBtn" disabled>Analyze</button>
      </form>

      <div id="resultado"></div>
      
      <div id="downloadBtnContainer" style="display: none;">
        <button type="button" id="downloadBtn" class="download-btn">Download PDF Report</button>
      </div>
    </div>
  </div>

  <div id="photoModal" class="modal">
    <span class="close">&times;</span>
    <div class="modal-nav modal-prev">&#10094;</div>
    <div class="modal-nav modal-next">&#10095;</div>
    <img class="modal-content" id="modalImage">
    <div id="modalCaption" class="modal-caption"></div>
  </div>

  <script>
    const selectInput = document.getElementById('selectInput');
    const selectedText = document.getElementById('selectedText');
    const selectArrow = document.getElementById('selectArrow');
    const optionsContainer = document.getElementById('optionsContainer');
    const searchInput = document.getElementById('searchInput');
    const optionsList = document.getElementById('optionsList');
    const submitBtn = document.getElementById('submitBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resultado = document.getElementById('resultado');
    const form = document.getElementById('formFinca');
    
    let farmsData = [];
    let selectedFarmIndex = null;
    let isOpen = false;
    let currentAnalysisData = null;
    let currentFarmData = null;
    let weeklyData = [];
    let availableWeeks = [];

    async function loadFarms() {
      try {
        await loadFarmsFromCSV();
      } catch (error) {
        console.error('Error loading farms:', error);
        loadFallbackData();
      }
    }

    async function loadFarmsFromCSV() {
      const strategies = [
        {
          name: 'AllOrigins Proxy',
          execute: async () => {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_e-zu9dC1Pzk3XmaKAMP4YhntP2yJ87Tkn6-uQd1flmv7cuY2yjdpK6XTZMKyCd2Qw7Ux41V8dUKx/pub?gid=2031029481&single=true&output=csv';
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
            const response = await fetch(proxyUrl, {
              method: 'GET',
              headers: { 'Accept': 'text/csv,text/plain,*/*' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.text();
          }
        },
        {
          name: 'JSONP Proxy',
          execute: async () => {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_e-zu9dC1Pzk3XmaKAMP4YhntP2yJ87Tkn6-uQd1flmv7cuY2yjdpK6XTZMKyCd2Qw7Ux41V8dUKx/pub?gid=2031029481&single=true&output=csv';
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            return data.contents;
          }
        }
      ];

      let csvText;
      let successfulStrategy = null;

      for (let i = 0; i < strategies.length; i++) {
        const strategy = strategies[i];
        try {
          console.log(`Trying strategy ${i + 1}: ${strategy.name}`);
          csvText = await strategy.execute();
          successfulStrategy = strategy.name;
          console.log(`Successfully loaded CSV data using: ${strategy.name}`);
          break;
        } catch (error) {
          console.warn(`Strategy ${i + 1} (${strategy.name}) failed:`, error.message);
          if (i === strategies.length - 1) {
            throw new Error('All loading strategies failed');
          }
          continue;
        }
      }
      
      if (!csvText) {
        throw new Error('Failed to load CSV data from all sources');
      }
      
      processCsvData(csvText);
      
      if (successfulStrategy) {
        console.log(`Data loaded successfully using: ${successfulStrategy}`);
      }
    }

    function processCsvData(csvText) {
      const lines = csvText.split('\n');
      farmsData = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const columns = parseCSVLine(line);
        
        if (columns.length >= 2) {
          const supplier = columns[0]?.trim() || '';
          const farmName = columns[1]?.trim() || '';
          const farmCode = columns[4]?.trim() || '';
          
          if (farmName && farmName !== 'FARMS' && farmName !== 'SUPPLIER') {
            const farmNameClean = farmName.split(' - ')[0];
            const displayText = `${supplier || 'N/A'} - ${farmCode || 'N/A'} - ${farmNameClean}`;
            
            farmsData.push({
              name: farmName,
              supplier: supplier,
              farmCode: farmCode,
              farmNameClean: farmNameClean,
              displayText: displayText
            });
          }
        }
      }
      
      if (farmsData.length === 0) {
        throw new Error('No valid farm data found');
      }
      
      updateSelectDisplay();
      populateOptions();
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    function loadFallbackData() {
      console.log('Loading fallback data due to CSV loading failure');
      
      const fallbackFarms = [
        { name: "PEPITA - AGRO FRESH", supplier: "AGRO FRESH", farmCode: "7190" },
        { name: "LA REVESA - ANDRADE COMEX", supplier: "ANDRADE COMEX", farmCode: "03200" },
        { name: "SEGUNDO MIGUEL - ANDRADE COMEX", supplier: "ANDRADE COMEX", farmCode: "10284" },
        { name: "SAN JOSÉ - ARQUEOL", supplier: "ARQUEOL", farmCode: "8500" },
        { name: "ENMITA DEL ROCIO - BANAVAL", supplier: "BANAVAL", farmCode: "9100" },
        { name: "DOS HERMANAS - DUREXPORTA", supplier: "DUREXPORTA", farmCode: "8100" },
        { name: "SANTA MONICA - EXPOFRUT", supplier: "EXPOFRUT", farmCode: "7500" }
      ];

      farmsData = fallbackFarms.map(farm => {
        const farmNameClean = farm.name.split(' - ')[0];
        const displayText = `${farm.supplier} - ${farm.farmCode || 'N/A'} - ${farmNameClean}`;
        
        return {
          ...farm,
          farmNameClean: farmNameClean,
          displayText: displayText
        };
      });
      
      const warningDiv = document.createElement('div');
      warningDiv.className = 'cors-warning';
      warningDiv.innerHTML = `
        <strong>Notice:</strong> Unable to load farms from Google Sheets due to CORS restrictions. 
        Using sample farm data instead. To access the full farm database, the page should be served from a web server.
      `;
      
      const container = document.querySelector('.container .section');
      container.insertBefore(warningDiv, container.firstChild);
      
      updateSelectDisplay();
      populateOptions();
    }

    function updateSelectDisplay() {
      if (selectedFarmIndex !== null) {
        const farm = farmsData[selectedFarmIndex];
        selectedText.textContent = farm.displayText;
        submitBtn.disabled = false;
      } else {
        selectedText.textContent = farmsData.length > 0 ? 'Select an option' : 'Loading farms...';
        submitBtn.disabled = true;
      }
    }

    function populateOptions() {
      optionsList.innerHTML = '';
      
      farmsData.forEach((farm, index) => {
        const option = document.createElement('div');
        option.className = 'option';
        option.textContent = farm.displayText;
        option.dataset.index = index;
        
        option.addEventListener('click', () => {
          selectFarm(index);
        });
        
        optionsList.appendChild(option);
      });
    }

    function selectFarm(index) {
      selectedFarmIndex = index;
      updateSelectDisplay();
      closeSelect();
      
      document.querySelectorAll('.option').forEach((opt, i) => {
        opt.classList.toggle('selected', i === index);
      });
    }

    function openSelect() {
      if (isOpen) return;
      
      isOpen = true;
      optionsContainer.classList.add('open');
      selectArrow.classList.add('open');
      searchInput.focus();
      searchInput.value = '';
      filterOptions('');
    }

    function closeSelect() {
      isOpen = false;
      optionsContainer.classList.remove('open');
      selectArrow.classList.remove('open');
    }

    function filterOptions(searchTerm) {
      const options = document.querySelectorAll('.option');
      let visibleCount = 0;
      
      options.forEach(option => {
        const farmName = option.textContent.toLowerCase();
        const matches = farmName.includes(searchTerm.toLowerCase());
        
        option.classList.toggle('hidden', !matches);
        if (matches) visibleCount++;
      });
      
      let noResultsMsg = document.querySelector('.no-results');
      if (visibleCount === 0) {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.className = 'no-results';
          noResultsMsg.textContent = 'No farms found';
          optionsList.appendChild(noResultsMsg);
        }
        noResultsMsg.style.display = 'block';
      } else if (noResultsMsg) {
        noResultsMsg.style.display = 'none';
      }
    }

    selectInput.addEventListener('click', () => {
      if (isOpen) {
        closeSelect();
      } else {
        openSelect();
      }
    });

    searchInput.addEventListener('input', (e) => {
      filterOptions(e.target.value);
    });

    searchInput.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    document.addEventListener('click', (e) => {
      if (!selectInput.contains(e.target) && !optionsContainer.contains(e.target)) {
        closeSelect();
      }
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeSelect();
      } else if (e.key === 'Enter') {
        const visibleOptions = Array.from(document.querySelectorAll('.option:not(.hidden)'));
        if (visibleOptions.length === 1) {
          const index = parseInt(visibleOptions[0].dataset.index);
          selectFarm(index);
        }
      }
    });

    async function generatePDFReport() {
  if (!currentAnalysisData || !currentFarmData) {
    alert('No analysis data available to download');
    return;
  }

  const downloadBtn = document.getElementById('downloadBtn');
  const originalText = downloadBtn.textContent;
  downloadBtn.textContent = 'Generating PDF...';
  downloadBtn.disabled = true;

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    function addCleanHeader() {
      // Solo una línea gris sutil
      doc.setDrawColor(220, 220, 220);
      doc.line(0, 15, 210, 15);
      yPos = 25;
    }
    
    function createStyledSection(title, items, headerColor = [40, 40, 40]) {
      doc.addPage();
      addCleanHeader();
      
      // Header colorido según tipo de datos
      doc.setFillColor(...headerColor);
      doc.rect(10, yPos, 190, 35, 'F');
      doc.setFontSize(24);
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, 'bold');
      doc.text(title, 105, yPos + 20, { align: 'center' });
      yPos += 50;
      
      items.forEach((item, index) => {
        const bgColor = index % 2 === 0 ? [248, 249, 250] : [255, 255, 255];
        doc.setFillColor(...bgColor);
        doc.rect(10, yPos, 190, 30, 'F');
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.rect(10, yPos, 190, 30);
        
        doc.setFontSize(18);
        doc.setTextColor(40, 40, 40);
        doc.setFont(undefined, 'bold');
        doc.text(item.key + ':', 20, yPos + 18);
        
        doc.setTextColor(102, 126, 234);
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text(String(item.value), 150, yPos + 18);
        doc.setFont(undefined, 'normal');
        
        yPos += 35;
      });
    }

    function loadImageWithoutRotation(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
          
          const dataURL = canvas.toDataURL('image/jpeg', 0.8);
          resolve(dataURL);
        };
        
        img.onerror = reject;
        img.src = url;
      });
    }

    async function addFullPagePhoto(imageUrl, problemName, photoNumber, totalPhotos, containerName) {
      doc.addPage();
      addCleanHeader();
      
      doc.setFillColor(40, 40, 40);
      doc.rect(10, yPos, 190, 25, 'F');
      doc.setFontSize(16);
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, 'bold');
      doc.text(`${containerName} - ${problemName}`, 105, yPos + 15, { align: 'center' });
      yPos += 30;
      
      doc.setFillColor(248, 249, 250);
      doc.rect(10, yPos, 190, 15, 'F');
      doc.setFontSize(14);
      doc.setTextColor(80, 80, 80);
      doc.setFont(undefined, 'bold');
      doc.text(`PHOTO ${photoNumber} OF ${totalPhotos}`, 105, yPos + 10, { align: 'center' });
      yPos += 20;
      
      try {
        const imageData = await loadImageWithoutRotation(imageUrl);
        
        const img = new Image();
        await new Promise(resolve => {
          img.onload = resolve;
          img.src = imageData;
        });
        
        const maxWidth = 160;
        const maxHeight = 180;
        let finalWidth, finalHeight;
        
        const aspectRatio = img.width / img.height;
        
        if (aspectRatio > 1) {
          finalWidth = Math.min(maxWidth, 140);
          finalHeight = finalWidth / aspectRatio;
        } else {
          finalHeight = maxHeight;
          finalWidth = finalHeight * aspectRatio;
        }
        
        const imageX = 105 - (finalWidth / 2);
        const imageY = yPos;
        
        doc.addImage(imageData, 'JPEG', imageX, imageY, finalWidth, finalHeight);
        
      } catch (error) {
        console.error('Error loading image:', error);
        doc.setFillColor(240, 240, 240);
        doc.rect(25, yPos, 160, 180, 'F');
        doc.setFontSize(18);
        doc.setTextColor(150, 150, 150);
        doc.text('IMAGE NOT AVAILABLE', 105, yPos + 90, { align: 'center' });
      }
    }

    function createBadContainersTable() {
      if (!currentAnalysisData.bad_containers_detail || currentAnalysisData.bad_containers_detail.length === 0) {
        return;
      }

      doc.addPage();
      addCleanHeader();
      
      // Header rojo para contenedores malos
      doc.setFillColor(220, 53, 69);
      doc.rect(10, yPos, 190, 35, 'F');
      doc.setFontSize(24);
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, 'bold');
      doc.text('BAD CONTAINERS DETAIL', 105, yPos + 20, { align: 'center' });
      yPos += 50;

      doc.setFillColor(248, 249, 250);
      doc.rect(10, yPos, 190, 20, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(10, yPos, 190, 20);
      
      doc.setFontSize(12);
      doc.setTextColor(60, 60, 60);
      doc.setFont(undefined, 'bold');
      doc.text('Container ID', 15, yPos + 13);
      doc.text('Fungus %', 70, yPos + 13);
      doc.text('Bruises %', 105, yPos + 13);
      doc.text('Weight (kg)', 140, yPos + 13);
      doc.text('Reason', 175, yPos + 13);
      yPos += 25;

      currentAnalysisData.bad_containers_detail.forEach((container, index) => {
        if (yPos > 250) {
          doc.addPage();
          addCleanHeader();
          yPos = 30;
        }
        
        const bgColor = index % 2 === 0 ? [255, 255, 255] : [248, 249, 250];
        doc.setFillColor(...bgColor);
        doc.rect(10, yPos, 190, 15, 'F');
        doc.setDrawColor(220, 220, 220);
        doc.rect(10, yPos, 190, 15);
        
        doc.setFontSize(10);
        doc.setTextColor(60, 60, 60);
        doc.setFont(undefined, 'normal');
        
        doc.text(container.container_id || 'N/A', 15, yPos + 10);
        doc.text((container.fungus_percentage || 0).toString(), 70, yPos + 10);
        doc.text((container.bruises_percentage || 0).toString(), 105, yPos + 10);
        doc.text((container.weight || 0).toString(), 140, yPos + 10);
        
        const reason = (container.failure_reason || 'Issues').substring(0, 15);
        doc.text(reason, 175, yPos + 10);
        
        yPos += 20;
      });
    }
    
    // PORTADA SIMPLE Y BONITA - reemplaza solo esta sección
// Fondo blanco limpio
doc.setFillColor(255, 255, 255);
doc.rect(0, 0, 210, 297, 'F');

// Header azul en la parte superior
doc.setFillColor(102, 126, 234);
doc.rect(0, 0, 210, 60, 'F');

// Título principal
doc.setFontSize(36);
doc.setTextColor(255, 255, 255);
doc.setFont(undefined, 'bold');
doc.text('GOODFARMER', 105, 35, { align: 'center' });

doc.setFontSize(16);
doc.setFont(undefined, 'normal');
doc.text('Quality Analysis Report', 105, 50, { align: 'center' });

// Línea decorativa simple
doc.setDrawColor(102, 126, 234);
doc.setLineWidth(3);
doc.line(50, 80, 160, 80);

// Información de la finca - caja simple
doc.setFillColor(248, 249, 250);
doc.rect(40, 110, 130, 100, 'F');
doc.setDrawColor(200, 200, 200);
doc.setLineWidth(1);
doc.rect(40, 110, 130, 100);

// Header de información
doc.setFontSize(20);
doc.setTextColor(102, 126, 234);
doc.setFont(undefined, 'bold');
doc.text('FARM DETAILS', 105, 135, { align: 'center' });

// Datos de la finca
doc.setFontSize(14);
doc.setTextColor(60, 60, 60);
doc.setFont(undefined, 'bold');
doc.text('EXPORTER:', 50, 160);
doc.setFont(undefined, 'normal');
doc.text(currentFarmData.supplier || 'N/A', 115, 160);

doc.setFont(undefined, 'bold');
doc.text('FARM CODE:', 50, 180);
doc.setFont(undefined, 'normal');
doc.text(currentFarmData.farmCode || 'N/A', 115, 180);

doc.setFont(undefined, 'bold');
doc.text('FARM NAME:', 50, 200);
doc.setFont(undefined, 'normal');
doc.text(currentFarmData.farmNameClean || 'N/A', 115, 200);

// Fecha simple en la parte inferior
doc.setFontSize(12);
doc.setTextColor(120, 120, 120);
doc.setFont(undefined, 'normal');
doc.text(`Report Generated: ${new Date().toLocaleDateString()}`, 105, 250, { align: 'center' });
    
    // SECCIONES CON COLORES
    const overviewData = [
      { key: 'TOTAL CONTAINERS', value: currentAnalysisData.total_containers || 0 },
      { key: 'CONTAINERS INSPECTED', value: currentAnalysisData.containers_with_quality_data || 0 },
      { key: 'GOOD QUALITY CONTAINERS', value: currentAnalysisData.good_containers?.count || 0 },
      { key: 'POOR QUALITY CONTAINERS', value: currentAnalysisData.bad_containers?.count || 0 }
    ];
    createStyledSection('EXECUTIVE SUMMARY', overviewData, [102, 126, 234]); // Azul
    
    // Contenedores buenos - VERDE
    const goodData = currentAnalysisData.good_containers || {};
    const goodContainerData = [
      { key: 'GOOD CONTAINERS', value: `${goodData.count || 0}` },
      { key: 'AVERAGE FUNGUS LEVEL', value: `${goodData.avg_fungus || 0}%` },
      { key: 'AVERAGE BRUISES LEVEL', value: `${goodData.avg_bruises || 0}%` },
      { key: 'AVERAGE WEIGHT', value: `${goodData.avg_weight || 0} kg` }
    ];
    createStyledSection('GOOD QUALITY METRICS', goodContainerData, [25, 135, 84]); // Verde
    
    // Contenedores malos - ROJO
    if (currentAnalysisData.bad_containers?.count > 0) {
      const badData = currentAnalysisData.bad_containers || {};
      const badContainerData = [
        { key: 'POOR CONTAINERS', value: `${badData.count || 0}` },
        { key: 'FAILED FUNGUS TEST', value: `${badData.by_fungus || 0}` },
        { key: 'FAILED BRUISES TEST', value: `${badData.by_bruises || 0}` },
        { key: 'FAILED WEIGHT TEST', value: `${badData.by_weight || 0}` }
      ];
      createStyledSection('POOR QUALITY METRICS', badContainerData, [220, 53, 69]); // Rojo
    }

    createBadContainersTable();
    
    // CONTENEDORES CON FOTOS
    if (weeklyData.length > 0) {
      const weekSelect = document.getElementById('weekSelect');
      const selectedWeek = weekSelect?.value || availableWeeks[availableWeeks.length - 1];
      
      if (selectedWeek) {
        const weekContainers = weeklyData.filter(item => item.semana === selectedWeek);
        const uniqueContainers = weekContainers.filter((container, index, self) => 
          index === self.findIndex(c => c.contenedor === container.contenedor)
        );
        
        for (let i = 0; i < Math.min(uniqueContainers.length, 3); i++) {
          const container = uniqueContainers[i];
          
          doc.addPage();
          addCleanHeader();
          
          doc.setFillColor(102, 126, 234);
          doc.rect(10, yPos, 190, 35, 'F');
          doc.setFontSize(24);
          doc.setTextColor(255, 255, 255);
          doc.setFont(undefined, 'bold');
          doc.text(`CONTAINER: ${container.contenedor}`, 105, yPos + 20, { align: 'center' });
          yPos += 50;
          
          if (container.rawData?.technical_issues) {
            const issues = Object.entries(container.rawData.technical_issues);
            doc.setFillColor(248, 249, 250);
            doc.rect(10, yPos, 190, 20, 'F');
            doc.setFontSize(16);
            doc.setTextColor(60, 60, 60);
            doc.setFont(undefined, 'bold');
            doc.text('TECHNICAL ISSUES DETECTED:', 20, yPos + 13);
            yPos += 30;
            
            issues.forEach(([issue, status]) => {
              doc.setFontSize(14);
              doc.setTextColor(80, 80, 80);
              doc.text(`• ${issue}: ${status}`, 20, yPos);
              yPos += 15;
            });
          }
          
          const fotosPorProblema = container.rawData?.fotos_por_problema || {};
          const problemNames = {
            'Problem 1': 'FRUIT AGE ISSUES',
            'Problem 2': 'USED TOP HANDS', 
            'Problem 3': 'HAND SHAPE DEFECTS',
            'Problem 4': 'CHEMICAL DAMAGE',
            'Problem 5': 'PE FOAM ISSUES',
            'Problem 6': 'PACKING ORDER',
            'Problem 7': 'WEIGHT PROBLEMS'
          };
          
          for (const [problemKey, problemName] of Object.entries(problemNames)) {
            if (fotosPorProblema[problemKey] && fotosPorProblema[problemKey].length > 0) {
              const photos = fotosPorProblema[problemKey];
              
              for (let photoIndex = 0; photoIndex < photos.length; photoIndex++) {
                const photoUrl = photos[photoIndex];
                await addFullPagePhoto(photoUrl, problemName, photoIndex + 1, photos.length, container.contenedor);
              }
            }
          }
        }
      }
    }
    
    const fileName = `GoodFarmer_Report_${currentFarmData.farmCode || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);

  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Error generating PDF report');
  } finally {
    downloadBtn.textContent = originalText;
    downloadBtn.disabled = false;
  }
}

    downloadBtn.addEventListener('click', generatePDFReport);

    async function loadWeeklyData(farmName) {
      try {
        console.log(`Loading weekly data from API for farm: "${farmName}"`);
        
        const apiUrl = `https://eduardobarona14.pythonanywhere.com/datos_semanales?finca=${encodeURIComponent(farmName)}`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        console.log(`Found ${data.contenedores.length} containers across ${data.semanas_disponibles.length} weeks`);
        
        const weeklyData = data.contenedores.map(container => ({
          semana: container.semana,
          contenedor: container.contenedor,
          descripcion: container.descripcion,
          problems: container.fotos || [],
          rawData: container
        }));
        
        return {
          weeklyData: weeklyData,
          availableWeeks: data.semanas_disponibles
        };
        
      } catch (error) {
        console.error('Error loading weekly data from API:', error);
        return { weeklyData: [], availableWeeks: [] };
      }
    }

    async function loadBadContainersData(farmName) {
      try {
        console.log(`Loading bad containers data for farm: "${farmName}"`);
        
        const apiUrl = `https://eduardobarona14.pythonanywhere.com/contenedores_malos?finca=${encodeURIComponent(farmName)}`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();

        const uniqueContainers = [];
        const seenContainers = new Set();
        
        (data.contenedores_malos || []).forEach(container => {
          if (!seenContainers.has(container.container_id)) {
            seenContainers.add(container.container_id);
            uniqueContainers.push(container);
          }
        });
    
        return uniqueContainers;
        
        if (data.error) {
          console.warn('Bad containers API error:', data.error);
          return [];
        }
        
        console.log(`Found ${data.contenedores_malos?.length || 0} bad containers`);
        return data.contenedores_malos || [];
        
      } catch (error) {
        console.error('Error loading bad containers data:', error);
        return [];
      }
    }

    function displayResults(jsonData, farmData) {
      currentAnalysisData = jsonData;
      currentFarmData = farmData;

      const resultDiv = document.createElement('div');
      resultDiv.className = 'result-section';

      const farmHeader = document.createElement('div');
      farmHeader.className = 'farm-header';
      farmHeader.innerHTML = `
        <div>EXPORTER: ${farmData.supplier || 'N/A'}</div>
        <div>FARM CODE: ${farmData.farmCode || 'N/A'}</div>
        <div>FARM NAME: ${farmData.farmNameClean || 'N/A'}</div>
      `;
      resultDiv.appendChild(farmHeader);

      const overviewSection = document.createElement('div');
      overviewSection.className = 'stats-overview';
      
      overviewSection.innerHTML = `
        <div class="overview-card">
          <h3>Total Containers</h3>
          <div class="big-number">${jsonData.total_containers || 0}</div>
        </div>
        <div class="overview-card">
          <h3>Inspected</h3>
          <div class="big-number">${jsonData.containers_with_quality_data || 0}</div>
        </div>
        <div class="overview-card" style="background: linear-gradient(135deg, #52c234 0%, #061700 100%);">
          <h3>Good Quality</h3>
          <div class="big-number">${jsonData.good_containers?.count || 0}</div>
        </div>
      `;
      
      if (jsonData.bad_containers?.count > 0) {
        overviewSection.innerHTML += `
          <div class="overview-card" style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);">
            <h3>Poor Quality</h3>
            <div class="big-number">${jsonData.bad_containers.count}</div>
          </div>
        `;
      }
      
      resultDiv.appendChild(overviewSection);

      const statsGrid = document.createElement('div');
      statsGrid.className = 'stats-grid';

      const goodContainers = document.createElement('div');
      goodContainers.className = 'stats-card good-card';
      const goodData = jsonData.good_containers || {};
      goodContainers.innerHTML = `
        <h3>GOOD QUALITY CONTAINERS</h3>
        <div class="stats-item">
          <span class="stats-label">Count:</span>
          <span class="stats-value good">${goodData.count || 0} containers</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">Average Fungus:</span>
          <span class="stats-value">${goodData.avg_fungus || 0}%</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">Average Bruises:</span>
          <span class="stats-value">${goodData.avg_bruises || 0}%</span>
        </div>
        <div class="stats-item">
          <span class="stats-label">Average Weight:</span>
          <span class="stats-value">${goodData.avg_weight || 0} kg</span>
        </div>
      `;
      statsGrid.appendChild(goodContainers);

      if (jsonData.bad_containers?.count > 0) {
        const badContainers = document.createElement('div');
        badContainers.className = 'stats-card bad-card';
        const badData = jsonData.bad_containers || {};
        badContainers.innerHTML = `
          <h3>POOR QUALITY CONTAINERS</h3>
          <div class="stats-item">
            <span class="stats-label">Total Poor Quality:</span>
            <span class="stats-value bad">${badData.count || 0} containers</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">Failed Fungus Test:</span>
            <span class="stats-value bad">${badData.by_fungus || 0} containers</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">Failed Bruises Test:</span>
            <span class="stats-value bad">${badData.by_bruises || 0} containers</span>
          </div>
          <div class="stats-item">
            <span class="stats-label">Failed Weight Test:</span>
            <span class="stats-value bad">${badData.by_weight || 0} containers</span>
          </div>
        `;
        statsGrid.appendChild(badContainers);

        const totalFailures = (badData.by_fungus || 0) + (badData.by_bruises || 0) + (badData.by_weight || 0);
        if (totalFailures > badData.count) {
          const overlapNotice = document.createElement('div');
          overlapNotice.className = 'overlap-notice';
          overlapNotice.innerHTML = `
            <strong>Note:</strong> A single container can fail multiple tests. 
            The sum of individual failure categories (${totalFailures}) may exceed 
            the total poor quality containers (${badData.count}).
          `;
          resultDiv.appendChild(overlapNotice);
        }
      }

      resultDiv.appendChild(statsGrid);

      // Load and display historical charts
console.log('CHARTS DEBUG: About to load historical data...');
loadHistoricalData(farmData.name).then(historicalData => {
  console.log('CHARTS DEBUG: Historical data received:', historicalData);
  console.log('CHARTS DEBUG: Data length:', historicalData.length);
  
  if (historicalData.length > 0) {
    console.log('CHARTS DEBUG: Creating charts section...');
    const chartsSection = createChartsSection(historicalData, jsonData, farmData);
    
    // Insert charts section before weekly analysis or at the end
    const weeklySection = resultDiv.querySelector('.weekly-analysis');
    if (weeklySection) {
      resultDiv.insertBefore(chartsSection, weeklySection);
      console.log('CHARTS DEBUG: Charts section inserted before weekly analysis');
    } else {
      resultDiv.appendChild(chartsSection);
      console.log('CHARTS DEBUG: Charts section appended to end');
    }
    
    // Render charts after DOM insertion
    setTimeout(() => {
      console.log('CHARTS DEBUG: Rendering charts...');
      renderCharts(historicalData);
    }, 100);
  } else {
    console.log('CHARTS DEBUG: No historical data available, charts not created');
  }
}).catch(error => {
  console.error('CHARTS DEBUG: Error in historical data promise:', error);
});

      // Load and display bad containers detail
      if (jsonData.bad_containers?.count > 0) {
        loadBadContainersData(farmData.name).then(badContainersDetail => {
          if (badContainersDetail.length > 0) {

            const uniqueBadContainers = badContainersDetail.filter((container, index, self) => 
              index === self.findIndex(c => c.container_id === container.container_id)
            );
            
            currentAnalysisData.bad_containers_detail = uniqueBadContainers;
            // Store the bad containers detail in the analysis data for PDF
            currentAnalysisData.bad_containers_detail = badContainersDetail;
            
            const badContainersList = document.createElement('div');
            badContainersList.className = 'bad-containers-list';
            
            let tableHTML = `
              <h3>BAD CONTAINERS DETAIL</h3>
              <table class="bad-containers-table">
                <thead>
                  <tr>
                    <th>Container ID</th>
                    <th>Fungus %</th>
                    <th>Bruises %</th>
                    <th>Weight (kg)</th>
                    <th>Failure Reason</th>
                    <th>Reviewed by</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            badContainersDetail.forEach(container => {
              const fungusClass = (container.fungus_percentage > 3) ? 'high' : '';
              const bruisesClass = (container.bruises_percentage > 35) ? 'high' : '';
              const weightClass = (container.weight < 14) ? 'low' : '';
              
              tableHTML += `
                <tr>
                  <td class="container-id">${container.container_id || 'N/A'}</td>
                  <td class="metric-value ${fungusClass}">${container.fungus_percentage || 0}%</td>
                  <td class="metric-value ${bruisesClass}">${container.bruises_percentage || 0}%</td>
                  <td class="metric-value ${weightClass}">${container.weight || 0}</td>
                  <td>${container.failure_reason || 'Multiple issues'}</td>
                  <td class="reviewed_by_us">${container.reviewed_by_technician || 'N/A'}</td>
                </tr>
              `;
            });
            
            tableHTML += `
                </tbody>
              </table>
            `;
            
            badContainersList.innerHTML = tableHTML;
            
            // Insert before the weekly analysis section
            const weeklySection = resultDiv.querySelector('.weekly-analysis');
            if (weeklySection) {
              resultDiv.insertBefore(badContainersList, weeklySection);
            } else {
              resultDiv.appendChild(badContainersList);
            }
          }
        });
      }

      if (jsonData.historical_probabilities && Object.keys(jsonData.historical_probabilities).length > 0) {
        const historyCard = document.createElement('div');
        historyCard.className = 'stats-card';
        historyCard.style.gridColumn = '1 / -1';
        historyCard.style.background = 'white';
        historyCard.style.color = '#333';
        historyCard.style.margin = '20px';
        historyCard.style.borderLeft = '5px solid gray';
        
        let historyHTML = '<h3>Historical Quality Probabilities</h3>';
        for (const [problem, percentage] of Object.entries(jsonData.historical_probabilities)) {
          const cleanName = problem.replace('Historical probability of ', '').replace('_', ' ');
          historyHTML += `
            <div class="stats-item">
              <span class="stats-label">${cleanName} failure rate:</span>
              <span class="stats-value">${percentage}%</span>
            </div>
          `;
        }
        historyCard.innerHTML = historyHTML;
        resultDiv.appendChild(historyCard);
      }

      if (jsonData.technical_issues && Object.keys(jsonData.technical_issues).length > 0) {
        const technicalCard = document.createElement('div');
        technicalCard.className = 'stats-card';
        technicalCard.style.gridColumn = '1 / -1';
        technicalCard.style.background = 'white';
        technicalCard.style.color = '#333';
        technicalCard.style.margin = '20px';
        technicalCard.style.borderLeft = '5px solid gray';
        
        let technicalHTML = '<h3>Technical Issues</h3>';
        for (const [issue, percentage] of Object.entries(jsonData.technical_issues)) {
          const cleanName = issue.replace(/^\d+\.-/, '').trim();
          technicalHTML += `
            <div class="stats-item">
              <span class="stats-label">${cleanName}:</span>
              <span class="stats-value" style="color: #d63384;">${percentage}%</span>
            </div>
          `;
        }
        technicalCard.innerHTML = technicalHTML;
        resultDiv.appendChild(technicalCard);
      }

      const weeklySection = showWeeklyAnalysisSection(farmData);
      resultDiv.appendChild(weeklySection);

      setTimeout(() => {
        initializeWeeklyAnalysis(farmData);
        
        // Show PDF download button after main analysis is complete
        const downloadBtnContainer = document.getElementById('downloadBtnContainer');
        if (downloadBtnContainer) {
          downloadBtnContainer.style.display = 'block';
          console.log('PDF download button displayed after main analysis');
        }
      }, 100);

      return resultDiv;
    }

    function showWeeklyAnalysisSection(farmData) {
      const weeklySection = document.createElement('div');
      weeklySection.className = 'weekly-analysis';
      weeklySection.id = 'weeklyAnalysis';
      
      weeklySection.innerHTML = `
        <div class="weekly-header">
          Weekly Container Analysis
        </div>
        
        <div class="week-selector">
          <label for="weekSelect">Choose Week:</label>
          <select id="weekSelect">
            <option value="">Loading weeks...</option>
          </select>
          <button type="button" id="searchWeekBtn" class="search-week-btn" disabled>
            Analyze Week
          </button>
        </div>
        
        <div id="weeklyResults">
          <div class="loading-weekly">Select a week to view detailed container analysis</div>
        </div>
      `;
      
      return weeklySection;
    }

    async function initializeWeeklyAnalysis(farmData) {
      const weekSelect = document.getElementById('weekSelect');
      const searchWeekBtn = document.getElementById('searchWeekBtn');
      const weeklyResults = document.getElementById('weeklyResults');
      
      weeklyResults.innerHTML = '<div class="loading-weekly">Loading weekly data...</div>';
      
      const { weeklyData: data, availableWeeks: weeks } = await loadWeeklyData(farmData.name);
      weeklyData = data;
      availableWeeks = weeks;
      
      weekSelect.innerHTML = '<option value="">Select a week...</option>';
      weeks.forEach(week => {
        const option = document.createElement('option');
        option.value = week;
        option.textContent = `Week ${week}`;
        weekSelect.appendChild(option);
      });
      
      if (weeks.length === 0) {
        weeklyResults.innerHTML = `
          <div class="no-containers">
            No weekly data found for this farm.
          </div>
        `;
        weekSelect.disabled = true;
      } else {
        searchWeekBtn.disabled = false;
        weeklyResults.innerHTML = '<div class="loading-weekly">Select a week to view detailed container analysis</div>';
      }
      
      searchWeekBtn.addEventListener('click', () => {
        const selectedWeek = weekSelect.value;
        if (selectedWeek) {
          showWeeklyResults(selectedWeek);
        }
      });
      
      weekSelect.addEventListener('change', () => {
        searchWeekBtn.disabled = !weekSelect.value;
      });
    }

    function showWeeklyResults(selectedWeek) {
      const weeklyResults = document.getElementById('weeklyResults');
      const allContainers = weeklyData.filter(item => item.semana === selectedWeek);
      
      // Remove duplicate containers by keeping only the first occurrence
      const seenContainers = new Set();
      const containers = allContainers.filter(container => {
        if (seenContainers.has(container.contenedor)) {
          console.log(`Removing duplicate container: ${container.contenedor}`);
          return false;
        }
        seenContainers.add(container.contenedor);
        return true;
      });
      
      console.log(`Found ${allContainers.length} total containers, ${containers.length} unique containers for week ${selectedWeek}`);
      
      if (containers.length === 0) {
        weeklyResults.innerHTML = `
          <div class="no-containers">
            No containers found for Week ${selectedWeek}
          </div>
        `;
        return;
      }
      
      weeklyResults.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; font-size: 1.2em; font-weight: bold; color: #6f42c1;">
          Week ${selectedWeek} - ${containers.length} Container${containers.length > 1 ? 's' : ''} Processed
        </div>
      `;
      
      const containersGrid = document.createElement('div');
      containersGrid.className = 'containers-grid';
      
      // Problem names mapping in the correct order
      const problemNames = {
        'Problem 1': 'FRUIT AGE',
        'Problem 2': 'USED TOP 2 HANDS', 
        'Problem 3': 'HAND SHAPE 12-18 FINGERS',
        'Problem 4': 'CHEMICAL',
        'Problem 5': 'PE FOAM SIZE',
        'Problem 6': 'PACKING ORDER',
        'Problem 7': 'WEIGHT'
      };
      
      containers.forEach((container) => {
        const containerCard = document.createElement('div');
        containerCard.className = 'container-card';
        
        // Technical Issues from API
        let issuesHTML = '';
        if (container.rawData && container.rawData.technical_issues && Object.keys(container.rawData.technical_issues).length > 0) {
          for (const [issue, status] of Object.entries(container.rawData.technical_issues)) {
            issuesHTML += `
              <div class="problem-item">
                <span class="problem-label">${issue}:</span>
                <span class="problem-percentage" style="color: #dc3545;">${status}</span>
              </div>
            `;
          }
        } else {
          issuesHTML = '<div class="problem-item"><span class="problem-label">No technical issues detected</span></div>';
        }
        
        // Photos organized by problems with proper names and order
        let photosHTML = '';
        const rawData = container.rawData || {};
        const fotosPorProblema = rawData.fotos_por_problema || {};
        const fotosGenerales = rawData.fotos || [];
        
        // Create ordered list of problems
        const orderedProblems = [];
        for (let i = 1; i <= 7; i++) {
          const problemKey = `Problem ${i}`;
          const problemName = problemNames[problemKey];
          if (fotosPorProblema[problemKey] && fotosPorProblema[problemKey].length > 0) {
            orderedProblems.push({
              key: problemKey,
              name: problemName,
              photos: fotosPorProblema[problemKey]
            });
          }
        }
        
        // Show photos by problem in correct order
        if (orderedProblems.length > 0) {
          photosHTML += '<div class="photos-section"><div class="photos-header">Photos by Detected Problems</div>';
          
          orderedProblems.forEach((problem) => {
            photosHTML += `
              <div class="problem-photos-container">
                <div class="problem-title">
                  ${problem.name} (${problem.photos.length} photo${problem.photos.length > 1 ? 's' : ''})
                </div>
                <div class="photos-grid">
            `;
            
            problem.photos.forEach((photoUrl, photoIndex) => {
              const photoId = `photo_${container.contenedor}_${problem.key}_${photoIndex}`;
              photosHTML += `
                <div class="photo-link" data-photo-url="${photoUrl}" 
                     data-caption="${problem.name} - Photo ${photoIndex + 1} - Container ${container.contenedor}"
                     onclick="openPhotoModal(this)">
                  <img src="${photoUrl}" alt="${problem.name} Photo ${photoIndex + 1}" 
                       onerror="this.style.display='none'; this.parentNode.innerHTML='Photo<br>${photoIndex + 1}';">
                </div>
              `;
            });
            
            photosHTML += '</div></div>';
          });
          
          photosHTML += '</div>';
        }
        
        // Show general photos if no specific problem photos are available
        if (fotosGenerales.length > 0 && orderedProblems.length === 0) {
          photosHTML += `
            <div class="photos-section">
              <div class="photos-header">Container Photos (${fotosGenerales.length})</div>
              <div class="photos-grid">
          `;
          
          fotosGenerales.forEach((photoUrl, photoIndex) => {
            photosHTML += `
              <div class="photo-link" data-photo-url="${photoUrl}" 
                   data-caption="General Photo ${photoIndex + 1} - Container ${container.contenedor}"
                   onclick="openPhotoModal(this)">
                <img src="${photoUrl}" alt="Container Photo ${photoIndex + 1}" 
                     onerror="this.style.display='none'; this.parentNode.innerHTML='Photo<br>${photoIndex + 1}';">
              </div>
            `;
          });
          
          photosHTML += '</div></div>';
        }
        
        // Additional container details
        let detailsHTML = '';
        if (rawData.hora_llegada) {
          detailsHTML += `
            <div class="problem-item">
              <span class="problem-label">Arrival Time:</span>
              <span class="stats-value">${rawData.hora_llegada}</span>
            </div>
          `;
        }
        
        if (rawData.peso_promedio) {
          detailsHTML += `
            <div class="problem-item">
              <span class="problem-label">Average Weight:</span>
              <span class="stats-value">${rawData.peso_promedio} lbs</span>
            </div>
          `;
        }
        
        if (rawData.porcentaje_hongos !== null && rawData.porcentaje_hongos !== undefined) {
          detailsHTML += `
            <div class="problem-item">
              <span class="problem-label">Fungus:</span>
              <span class="stats-value">${rawData.porcentaje_hongos}%</span>
            </div>
          `;
        }
        
        if (rawData.porcentaje_golpes !== null && rawData.porcentaje_golpes !== undefined) {
          detailsHTML += `
            <div class="problem-item">
              <span class="problem-label">Bruises:</span>
              <span class="stats-value">${rawData.porcentaje_golpes}%</span>
            </div>
          `;
        }
        
        containerCard.innerHTML = `
          <div class="container-header">
            Container: ${container.contenedor}
          </div>
          
          <div class="problems-section">
            <h4 style="color: #6f42c1; margin-bottom: 10px; font-size: 1.1em;">Technical Issues Detected</h4>
            ${issuesHTML}
            ${detailsHTML ? '<h4 style="color: #6f42c1; margin: 15px 0 10px 0; font-size: 1.1em;">Quality Metrics</h4>' + detailsHTML : ''}
          </div>
          
          ${photosHTML}
        `;
        
        containersGrid.appendChild(containerCard);
      });
      
      weeklyResults.appendChild(containersGrid);
      
      setTimeout(() => {
        const downloadBtnContainer = document.getElementById('downloadBtnContainer');
        if (downloadBtnContainer) {
          downloadBtnContainer.style.display = 'block';
          console.log('PDF download button should now be visible');
        }
      }, 500);
    }

    function parseTextToJSON(text) {
      const result = {
        total_containers: 0,
        containers_with_quality_data: 0,
        good_containers: {
          count: 0,
          avg_fungus: 0,
          avg_bruises: 0,
          avg_weight: 0
        },
        bad_containers: {
          count: 0,
          by_fungus: 0,
          by_bruises: 0,
          by_weight: 0
        },
        historical_probabilities: {},
        technical_issues: {}
      };

      let match = text.match(/Total containers from this farm:\s*(\d+)/i);
      if (match) result.total_containers = parseInt(match[1]);

      match = text.match(/containers with quality data:\s*(\d+)/i);
      if (match) result.containers_with_quality_data = parseInt(match[1]);

      match = text.match(/good containers:\s*(\d+)/i);
      if (match) result.good_containers.count = parseInt(match[1]);

      match = text.match(/Average Fungus:\s*([\d.]+)%/i);
      if (match) result.good_containers.avg_fungus = parseFloat(match[1]);

      match = text.match(/Average Bruises:\s*([\d.]+)%/i);
      if (match) result.good_containers.avg_bruises = parseFloat(match[1]);

      match = text.match(/Average Weight:\s*([\d.]+)\s*(?:lbs|kg)/i);
      if (match) result.good_containers.avg_weight = parseFloat(match[1]);

      match = text.match(/Total bad containers:\s*(\d+)/i);
      if (match) result.bad_containers.count = parseInt(match[1]);

      match = text.match(/Bad due to Fungus:\s*(\d+)/i);
      if (match) result.bad_containers.by_fungus = parseInt(match[1]);

      match = text.match(/Bad due to Bruises:\s*(\d+)/i);
      if (match) result.bad_containers.by_bruises = parseInt(match[1]);

      match = text.match(/Bad due to Weight:\s*(\d+)/i);
      if (match) result.bad_containers.by_weight = parseInt(match[1]);

      const probabilityRegex = /Historical probability of (\w+):\s*([\d.]+)%/g;
      let probabilityMatch;
      while ((probabilityMatch = probabilityRegex.exec(text)) !== null) {
        result.historical_probabilities[probabilityMatch[1]] = parseFloat(probabilityMatch[2]);
      }

      result.original_text = text;
      return result;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (selectedFarmIndex === null) {
        resultado.innerHTML = '<div class="error-message">Please select a farm</div>';
        return;
      }

      const farm = farmsData[selectedFarmIndex];
      const finca = farm.name;

      resultado.innerHTML = '<div class="loading">Analyzing farm data...</div>';
      
      const downloadBtnContainer = document.getElementById('downloadBtnContainer');
      if (downloadBtnContainer) {
        downloadBtnContainer.style.display = 'none';
      }

      try {
        const apiUrl = `https://eduardobarona14.pythonanywhere.com/analizar_json?finca=${encodeURIComponent(finca)}`;
        console.log('Calling API:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          const jsonData = await response.json();
          console.log('JSON data received:', jsonData);
          
          if (jsonData.error) {
            throw new Error(jsonData.error);
          }
          
          const enhancedResults = displayResults(jsonData, farm);
          resultado.innerHTML = '';
          resultado.appendChild(enhancedResults);
          
        } else {
          const textData = await response.text();
          console.log('Text data received:', textData.substring(0, 200));
          
          const parsedData = parseTextToJSON(textData);
          const enhancedResults = displayResults(parsedData, farm);
          resultado.innerHTML = '';
          resultado.appendChild(enhancedResults);
        }
        
      } catch (error) {
        console.error('Error:', error);
        resultado.innerHTML = `
          <div class="error-message">
            Error in query: ${error.message}
            <br><small>Check your connection and try again</small>
          </div>
        `;
      }
    });

    loadFarms();

    // Photo modal functionality
    let currentPhotoIndex = 0;
    let currentPhotoSet = [];

    function openPhotoModal(element) {
      const modal = document.getElementById('photoModal');
      const modalImg = document.getElementById('modalImage');
      const captionText = document.getElementById('modalCaption');
      
      // Get all photos in the current container
      const container = element.closest('.container-card');
      const allPhotoLinks = container.querySelectorAll('.photo-link[data-photo-url]');
      
      currentPhotoSet = Array.from(allPhotoLinks).map(link => ({
        url: link.dataset.photoUrl,
        caption: link.dataset.caption
      }));
      
      currentPhotoIndex = Array.from(allPhotoLinks).indexOf(element);
      
      modal.style.display = 'block';
      modalImg.src = element.dataset.photoUrl;
      captionText.innerHTML = element.dataset.caption;
      
      // Add keyboard event listener
      document.addEventListener('keydown', handleModalKeydown);
    }

    function closeModal() {
      const modal = document.getElementById('photoModal');
      modal.style.display = 'none';
      document.removeEventListener('keydown', handleModalKeydown);
    }

    function showNextPhoto() {
      if (currentPhotoSet.length === 0) return;
      
      currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotoSet.length;
      const modalImg = document.getElementById('modalImage');
      const captionText = document.getElementById('modalCaption');
      
      modalImg.src = currentPhotoSet[currentPhotoIndex].url;
      captionText.innerHTML = currentPhotoSet[currentPhotoIndex].caption;
    }

    function showPrevPhoto() {
      if (currentPhotoSet.length === 0) return;
      
      currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotoSet.length) % currentPhotoSet.length;
      const modalImg = document.getElementById('modalImage');
      const captionText = document.getElementById('modalCaption');
      
      modalImg.src = currentPhotoSet[currentPhotoIndex].url;
      captionText.innerHTML = currentPhotoSet[currentPhotoIndex].caption;
    }

    function handleModalKeydown(event) {
      switch(event.key) {
        case 'Escape':
          closeModal();
          break;
        case 'ArrowLeft':
          showPrevPhoto();
          break;
        case 'ArrowRight':
          showNextPhoto();
          break;
      }
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('photoModal');
      const closeBtn = document.querySelector('.close');
      const prevBtn = document.querySelector('.modal-prev');
      const nextBtn = document.querySelector('.modal-next');

      if (closeBtn) closeBtn.onclick = closeModal;
      if (prevBtn) prevBtn.onclick = showPrevPhoto;
      if (nextBtn) nextBtn.onclick = showNextPhoto;

      // Close modal when clicking outside the image
      if (modal) {
        modal.onclick = function(event) {
          if (event.target === modal) {
            closeModal();
          }
        };
      }
    });

    async function loadHistoricalData(farmName) {
        try {
    console.log('CHARTS DEBUG: Loading historical data for:', farmName);
    const apiUrl = `https://eduardobarona14.pythonanywhere.com/historico_calidad?finca=${encodeURIComponent(farmName)}`;
    console.log('CHARTS DEBUG: API URL:', apiUrl);
    
    const response = await fetch(apiUrl);
    console.log('CHARTS DEBUG: Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`API returned ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('CHARTS DEBUG: Response data:', data);
    console.log('CHARTS DEBUG: Historical data length:', data.historical_data?.length || 0);
    
    return data.historical_data || [];
    
  } catch (error) {
    console.error('CHARTS DEBUG: Error loading historical data:', error);
    return [];
  }
        try {
          const apiUrl = `https://eduardobarona14.pythonanywhere.com/historico_calidad?finca=${encodeURIComponent(farmName)}`;
          const response = await fetch(apiUrl);
          
          if (!response.ok) {
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          return data.historical_data || [];
          
        } catch (error) {
          console.error('Error loading historical data:', error);
          return [];
        }
      }

      function calculateQualityScore(jsonData) {
        const total = jsonData.containers_with_quality_data || 0;
        const good = jsonData.good_containers?.count || 0;
        
        if (total === 0) return 0;
        return Math.round((good / total) * 100);
      }

      function getQualityDescription(score) {
        if (score >= 95) return "Exceptional Quality";
        if (score >= 90) return "Excellent Quality";
        if (score >= 85) return "Very Good Quality";
        if (score >= 80) return "Good Quality";
        if (score >= 70) return "Acceptable Quality";
        if (score >= 60) return "Below Average";
        return "Poor Quality";
      }

      function createChartsSection(historicalData, currentData, farmData) {
        const chartsSection = document.createElement('div');
        chartsSection.className = 'charts-section';
        chartsSection.id = 'chartsSection';
        
        // Calculate quality score
        const qualityScore = calculateQualityScore(currentData);
        const qualityDesc = getQualityDescription(qualityScore);
        
        chartsSection.innerHTML = `
          <div class="charts-header">
            Historical Quality Analysis & Trends
          </div>
          
          <div class="quality-score">
            <h3>Overall Farm Quality Score</h3>
            <div class="quality-percentage">${qualityScore}%</div>
            <div class="quality-description">${qualityDesc}</div>
            <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
              Based on ${currentData.containers_with_quality_data || 0} inspected containers
            </div>
          </div>
          
          <div class="charts-grid">
            <div class="chart-container">
              <div class="chart-title">Good vs Bad Containers by Week</div>
              <div class="chart-canvas">
                <canvas id="goodVsBadChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <div class="chart-title">Average Fungus Level Trend</div>
              <div class="chart-canvas">
                <canvas id="fungusChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <div class="chart-title">Average Bruises Level Trend</div>
              <div class="chart-canvas">
                <canvas id="bruisesChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <div class="chart-title">Average Weight Trend</div>
              <div class="chart-canvas">
                <canvas id="weightChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <div class="chart-title">Problem Distribution</div>
              <div class="chart-canvas">
                <canvas id="problemsChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <div class="chart-title">Quality Percentage by Week</div>
              <div class="chart-canvas">
                <canvas id="qualityChart"></canvas>
              </div>
            </div>
          </div>
        `;
        
        return chartsSection;
      }

      function renderCharts(historicalData) {
        if (!historicalData || historicalData.length === 0) {
          console.log('No historical data available for charts');
          return;
        }
        
        const labels = historicalData.map(item => item.period);
        
        // Chart 1: Good vs Bad Containers
        const ctx1 = document.getElementById('goodVsBadChart');
        if (ctx1) {
          new Chart(ctx1, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Good Containers',
                data: historicalData.map(item => item.good_containers),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
              }, {
                label: 'Bad Containers',
                data: historicalData.map(item => item.bad_containers),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
        
        // Chart 2: Fungus Trend
        const ctx2 = document.getElementById('fungusChart');
        if (ctx2) {
          new Chart(ctx2, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Average Fungus %',
                data: historicalData.map(item => item.avg_fungus),
                borderColor: '#fd7e14',
                backgroundColor: 'rgba(253, 126, 20, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: Math.max(...historicalData.map(item => item.avg_fungus)) + 2
                }
              }
            }
          });
        }
        
        // Chart 3: Bruises Trend
        const ctx3 = document.getElementById('bruisesChart');
        if (ctx3) {
          new Chart(ctx3, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Average Bruises %',
                data: historicalData.map(item => item.avg_bruises),
                borderColor: '#6f42c1',
                backgroundColor: 'rgba(111, 66, 193, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: Math.max(...historicalData.map(item => item.avg_bruises)) + 5
                }
              }
            }
          });
        }
        
        // Chart 4: Weight Trend
        const ctx4 = document.getElementById('weightChart');
        if (ctx4) {
          new Chart(ctx4, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Average Weight (kg)',
                data: historicalData.map(item => item.avg_weight),
                borderColor: '#20c997',
                backgroundColor: 'rgba(32, 201, 151, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  min: Math.min(...historicalData.map(item => item.avg_weight)) - 1,
                  max: Math.max(...historicalData.map(item => item.avg_weight)) + 1
                }
              }
            }
          });
        }
        
        // Chart 5: Problems Distribution (Pie Chart)
        const ctx5 = document.getElementById('problemsChart');
        if (ctx5) {
          const totalFungus = historicalData.reduce((sum, item) => sum + (item.fungus_issues || 0), 0);
          const totalBruises = historicalData.reduce((sum, item) => sum + (item.bruises_issues || 0), 0);
          const totalWeight = historicalData.reduce((sum, item) => sum + (item.weight_issues || 0), 0);
          
          new Chart(ctx5, {
            type: 'doughnut',
            data: {
              labels: ['Fungus Issues', 'Bruises Issues', 'Weight Issues'],
              datasets: [{
                data: [totalFungus, totalBruises, totalWeight],
                backgroundColor: ['#fd7e14', '#6f42c1', '#20c997'],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                }
              }
            }
          });
        }
        
        // Chart 6: Quality Percentage by Week
        const ctx6 = document.getElementById('qualityChart');
        if (ctx6) {
          const qualityPercentages = historicalData.map(item => {
            const total = item.total_containers;
            const good = item.good_containers;
            return total > 0 ? Math.round((good / total) * 100) : 0;
          });
          
          new Chart(ctx6, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Quality %',
                data: qualityPercentages,
                backgroundColor: qualityPercentages.map(pct => 
                  pct >= 90 ? 'rgba(40, 167, 69, 0.8)' :
                  pct >= 80 ? 'rgba(255, 193, 7, 0.8)' :
                  'rgba(220, 53, 69, 0.8)'
                ),
                borderColor: qualityPercentages.map(pct => 
                  pct >= 90 ? '#28a745' :
                  pct >= 80 ? '#ffc107' :
                  '#dc3545'
                ),
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    callback: function(value) {
                      return value + '%';
                    }
                  }
                }
              }
            }
          });
        }
      }

    // Make openPhotoModal globally available
    window.openPhotoModal = openPhotoModal;
  </script>

</body>
</html>